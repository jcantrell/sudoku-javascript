<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <style>
    * { padding: 0; margin: 0; }
    canvas { background: #fff; display: block; margin: 0 auto; }
  </style>
</head>
<body>
  <canvas id="mainCanvas" width="480" height="320"></canvas>
<script> 
class Point { 
  constructor(x=0,y=0) {
    this.x=x;
    this.y=y;
  }
  asString() {
    return "(Pt "+x+" "+y+")";
  }
}
class Line {
  constructor (a, b) {
    this.a = a;
    this.b = b;
  }
  draw (ctx) {
    ctx.beginPath();
    ctx.strokeStyle = 'blue';
    ctx.lineWidth = 1;
    ctx.moveTo(this.a.x,this.a.y);
    ctx.lineTo(this.b.x,this.b.y);
    ctx.stroke();
  }
  asString() {
    return "(Line: "+this.a.asString()+" "+this.b.asString()+")"
  }
}
class Sudoku {
  constructor(xin=0,yin=0) {
    this.board = [
      [0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0]
    ];
    this.inked = [
      [0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0]
    ];
    this.focus = { x: 0, y: 0, r: 0, c: 0 };
    this.tl = new Point(xin,yin);
    this.bw = 50;
    this.bh = 50;
    this.debug = true;
  }
  asString() {
    var s="";
    for (var r=0;r<9;r++) { 
      for (var c=0;c<9;c++) {
        s+=this.board[r][c]+" ";
      }
      s+="\n";
    }
    s+="Valid: "+this.isValid(this.board)+" isFull: "+this.isFull(this.board)
      +"\n";
    return s;
  }
  copy() {
    var ret = new Sudoku();
    for (var r=0;r<9;r++) for (var c=0; c<9; c++) 
      ret.board[r][c] = this.board[r][c];
    ret.focus.x = this.focus.x; ret.focus.y = this.focus.y; ret.focus.r = this.focus.r; ret.focus.c = this.focus.c;
    ret.tl.x = this.tl.x; ret.tl.y = this.tl.y;
    ret.bw = this.bw;
    ret.bh = this.bh;
    return ret;
  }
  copyFrom(i) {
    for (var r=0;r<9;r++) for (var c=0; c<9; c++) 
      this.board[r][c] = i.board[r][c];
  }
  copyBoard(bin) {
    var b = [
      [0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0]
    ];
    for (var r=0;r<9;r++) for (var c=0; c<9; c++) b[r][c] = bin[r][c];
    return b;
  }
  draw (ctx) {
    this.tl.x = ctx.canvas.getBoundingClientRect().left;
    this.tl.y = ctx.canvas.getBoundingClientRect().top;

    // Background
    ctx.fillStyle = "lightgrey";
    ctx.fillRect(0,0,ctx.canvas.width,ctx.canvas.height);
    
    // Highlight focused row and column
    for (var i=0;i<9;i++) {
      ctx.fillStyle = "#bbbbbb";
      ctx.fillRect(i*this.bw,this.focus.r*this.bh,this.bw,this.bh);
      ctx.fillRect(this.focus.c*this.bw,i*this.bh,this.bw,this.bh);
    }

    // Highlight focused square
    ctx.fillStyle = "#cccccc";
    ctx.fillRect(this.focus.c*this.bw,this.focus.r*this.bh,this.bw,this.bh);

    // Outline individual squares
    for (var r=0;r<9;r++) {
      for (var c=0;c<9;c++) {
        ctx.strokeStyle = 'grey';
        ctx.strokeRect(c*this.bw, r*this.bh, this.bw, this.bh);
      }
    }

    // Draw 3x3 outlined squares
    ctx.strokeStyle = 'black';
    ctx.lineWidth = 2;
    for (var r=0;r<3;r++) {
      for (var c=0;c<3;c++) {
        ctx.strokeRect(c*this.bw*3, r*this.bh*3, this.bw*3, this.bh*3);
      }
    }
    ctx.lineWidth = 1;

    // Print numbers
    for (var r=0;r<9;r++) {
      for (var c=0;c<9;c++) {
        ctx.fillStyle = 'black';
        ctx.font = '16px serif';
        if (this.board[r][c] != 0)
          ctx.fillText(this.board[r][c],(c+1)*this.bw-30,(r+1)*this.bh-20);
      }
    }
  }
  click(ctx,e) {
    ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
    this.focus.x = e.x - this.tl.x; 
    this.focus.y = e.y - this.tl.y;
    this.focus.r = Math.floor(this.focus.y / this.bh);
    this.focus.c = Math.floor(this.focus.x / this.bw);
    this.draw(ctx);
  }
  ink(x,y,v) {
    this.board[x][y] = v;
    this.inked[x][y] = 1;
  }
  solve (b) {
    if (!b.isValid()) return false;
    if (b.isFull()) 
    {
      this.db("SOLUTION FOUND!\n");
      this.db(b.asString());
      this.db("XXXXXXXXXXXXXX!\n");
      return true;
    }
    // Find first penciled square
    var s = {x: 0, y: 0};
    for (s.x=0;s.x<9 && b.board[s.x][s.y] != 0;s.x++) {
      for (s.y=0;s.y<9 && b.board[s.x][s.y] != 0;s.y++)
        ;
    s.x--;s.y--;
    //this.db("Fist blank: "+s.x+" "+s.y+" "+b.board[s.x][s.y]+"\n");
    for (var v=1;v<=9;v++) {
      b.board[s.x][s.y] = v;
      if (this.solve(b))
        return true; 
    }
    this.db("solve failed\n");
    return false;
  }
  db(text) {
    if (this.debug) console.log(text);
  }
  keypress(ctx,e) {
    if (e.keyCode >= 48 && e.keyCode <= 57) {
      this.board[this.focus.r][this.focus.c] = e.keyCode - 48;
      this.draw(ctx);
      this.isValid(this.board);
    } else if (e.keyCode == 83) {
      var t = this.copy();
      this.solve(t);
      console.log(this.asString()+"\n");
      this.draw(ctx);
    }
  }
  isValid(b = this.board) {
    var totals = [
      [
        [0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0]
      ],
      [
        [0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0]
      ],
      [
        [0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0]
      ]
    ];
    for (var r=0;r<9;r++) {
      for (var c=0;c<9;c++) {
        if (this.board[r][c] != 0) {
          totals[0][r][b[r][c]-1]++;
          totals[1][c][b[r][c]-1]++;
          totals[2][Math.floor(r/3)*3+Math.floor(c/3)][b[r][c]-1]++;
        }
      }
    }
    var flag=true;
    for (var i=0;i<3;i++) {
      for (var r=0;r<9;r++) {
        for (var c=0;c<9;c++) {
          flag = flag && !(totals[i][r][c] > 1);
        }
      }
    }
    return flag;
  }
  isFull(b = this.board) {
    var flag = true;
    for (var r=0;r<9;r++)
      for (var c=0;c<9;c++)
        flag = flag && (b[r][c] != 0);
    return flag;
  }
}

var canvas = document.getElementById("mainCanvas");
var ctx = canvas.getContext('2d');
let sudoku = new Sudoku(ctx.canvas.getBoundingClientRect().left,ctx.canvas.getBoundingClientRect().top);
sudoku.board[0][0] = 5;
sudoku.board[0][2] = 9;
sudoku.board[0][8] = 3;
sudoku.board[1][0] = 1;
sudoku.board[1][5] = 9;
sudoku.board[1][7] = 8;
sudoku.board[1][8] = 2;
sudoku.board[2][1] = 7;
sudoku.board[2][4] = 8;
sudoku.board[2][5] = 5;
sudoku.board[2][6] = 9;
sudoku.board[2][7] = 4;
sudoku.board[3][1] = 2;
sudoku.board[3][3] = 8;
sudoku.board[3][4] = 3;
sudoku.board[3][6] = 7;
sudoku.board[4][2] = 8;
sudoku.board[4][6] = 3;
sudoku.board[5][2] = 7;
sudoku.board[5][4] = 9;
sudoku.board[5][5] = 1;
sudoku.board[5][7] = 2;
sudoku.board[6][1] = 6;
sudoku.board[6][2] = 2;
sudoku.board[6][3] = 1;
sudoku.board[6][4] = 5;
sudoku.board[6][7] = 9;
sudoku.board[7][0] = 9;
sudoku.board[7][1] = 4;
sudoku.board[7][3] = 6;
sudoku.board[7][8] = 7;
sudoku.board[8][0] = 8;
sudoku.board[8][6] = 2;
sudoku.board[8][8] = 5;
sudoku.ink(0,0,5);
sudoku.ink(0,2,9);
console.log("Here is sudoku:\n"+sudoku.asString());
var canvas = document.getElementById("mainCanvas");
document.addEventListener("mousedown", mouseDownHandler);
document.addEventListener("keydown", keyDownHandler);
document.addEventListener("mousemove", mouseMoveHandler);
canvas.width = 450;
canvas.height = 450;
sudoku.draw(ctx);
function mouseDownHandler(e) {
  var x = e.x - sudoku.tl.x;
  var y = e.y - sudoku.tl.y;
  if ((x <= canvas.width) && (y <= canvas.height) && x >= 0 && y >= 0)
    sudoku.click(ctx,e);
}
function keyDownHandler(e) {
  sudoku.keypress(ctx,e);
}
function mouseMoveHandler(e) {
  if (e.x <= canvas.width && e.y <= canvas.height)
    sudoku.keypress(ctx,e);
}
</script>
</body>
</html>
